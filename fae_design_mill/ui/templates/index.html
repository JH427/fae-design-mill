{% extends 'base.html' %}
{% block body %}
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold">Dashboard</h1>
    <div class="flex gap-2">
      <button id="btn_run" class="px-3 py-2 bg-slate-900 text-white rounded hover:bg-slate-800" onclick="runNow()">Run Now</button>
      <button id="btn_new" class="px-3 py-2 bg-slate-700 text-white rounded hover:bg-slate-600" onclick="runNew()">New Prompt</button>
      <button id="btn_prev" class="px-3 py-2 bg-white border border-slate-300 rounded hover:bg-slate-100" onclick="preview()">Preview Prompt</button>
    </div>
  </div>

  <div id="out" class="mb-6"></div>

  <section>
    <h2 class="text-lg font-medium mb-3">Recent</h2>
    <div id="recent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </section>

  <script>
    let polling = null;
    let generating = false;
    function setGenerating(on) {
      generating = on;
      const btnRun = document.getElementById('btn_run');
      const btnPrev = document.getElementById('btn_prev');
      const btnNew = document.getElementById('btn_new');
      if (on) {
        btnRun.disabled = true; btnPrev.disabled = true; btnNew.disabled = true;
        btnRun.textContent = 'Generating...';
      } else {
        btnRun.disabled = false; btnPrev.disabled = false; btnNew.disabled = false;
        btnRun.textContent = 'Run Now';
      }
    }
    async function runNow() {
      setGenerating(true);
      const res = await fetch('/api/run', {method: 'POST'});
      const data = await res.json();
      document.getElementById('out').innerHTML = '<pre class="bg-slate-900/90 text-green-200 p-3 rounded overflow-auto">'+JSON.stringify(data, null, 2)+'</pre>'
      startPolling();
    }
    async function runNew() {
      setGenerating(true);
      const res = await fetch('/api/run', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({force_new: true, random_seed: true})});
      const data = await res.json();
      document.getElementById('out').innerHTML = '<pre class="bg-slate-900/90 text-emerald-200 p-3 rounded overflow-auto">'+JSON.stringify(data, null, 2)+'</pre>'
      startPolling();
    }
    async function preview() {
      const res = await fetch('/api/preview', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({title: 'Preview'})});
      const data = await res.json();
      document.getElementById('out').innerHTML = '<pre class="bg-slate-900/90 text-blue-200 p-3 rounded overflow-auto">'+JSON.stringify(data, null, 2)+'</pre>'
    }
    async function loadRuns() {
      const res = await fetch('/api/runs');
      const data = await res.json();
      const items = data.items || [];
      let html = '';
      // Detect in-progress
      const inprog = items.find(it => it.status === 'PENDING' || it.status === 'PROMPTED');
      if (inprog) setGenerating(true); else setGenerating(false);
      for (const it of items) {
        const statusClass = it.status==='GENERATED' ? 'bg-green-50 border-green-200 text-green-700' : it.status==='FAILED' ? 'bg-red-50 border-red-200 text-red-700' : it.status==='PROMPTED' ? 'bg-amber-50 border-amber-200 text-amber-700' : 'bg-slate-50 border-slate-200 text-slate-700';
        html += `
          <div class="rounded border border-slate-200 bg-white overflow-hidden">
            ${it.file_url ? `<a href="${it.file_url}" target="_blank"><img src="${it.file_url}" loading="lazy" class="w-full max-h-96 object-contain bg-slate-100" /></a>` : ''}
            <div class="p-3">
              <div class="flex items-center justify-between mb-2">
                <div class="font-medium">#${it.run_id}</div>
                <span class="text-xs px-2 py-1 rounded border ${statusClass}">${it.status}</span>
              </div>
              ${it.file_url ? `<div class="text-xs text-slate-600 break-all"><a href="${it.file_url}" target="_blank">open image</a></div>` : ''}
              <div class="text-xs text-slate-500">${it.created_at || ''}</div>
            </div>
          </div>`;
      }
      document.getElementById('recent').innerHTML = html;
    }
    function startPolling() {
      if (polling) clearInterval(polling);
      loadRuns();
      polling = setInterval(loadRuns, 2000);
      setTimeout(() => { if (polling) { clearInterval(polling); polling = null; } }, 30000);
    }
    startPolling();
  </script>
{% endblock %}
