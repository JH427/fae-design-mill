{% extends 'base.html' %}
{% block body %}
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-semibold">Manage Items: <code class="px-1.5 bg-slate-100 rounded">{{ list_name }}</code></h1>
    <a class="px-3 py-2 bg-white border border-slate-300 rounded hover:bg-slate-100" href="/variables">Back to Variables</a>
  </div>

  <div class="rounded border border-slate-200 bg-white p-4 mb-6">
    <h3 class="font-medium mb-2">Add Item(s)</h3>
    <p class="text-sm text-slate-600 mb-2">Enter one value per line, comma-separated, or a JSON array.</p>
    <textarea id="values" rows="5" class="w-full border border-slate-300 rounded px-2 py-1 mb-3"></textarea>
    <div class="flex flex-wrap items-center gap-3 mb-3">
      <label class="text-sm">Weight: <input id="weight" type="number" step="0.1" value="1.0" class="border border-slate-300 rounded px-2 py-1 w-24"/></label>
      <label class="text-sm">Cooldown days: <input id="cooldown" type="number" step="1" value="0" class="border border-slate-300 rounded px-2 py-1 w-24"/></label>
      <label class="text-sm flex items-center gap-2"><input id="enabled" type="checkbox" checked class="scale-125"/> Enabled</label>
    </div>
    <div class="mb-3">
      <label class="text-sm">Tags (JSON array):</label>
      <input id="tags" class="border border-slate-300 rounded px-2 py-1 w-96" placeholder='["tag1","tag2"]'/>
    </div>
    <button class="px-3 py-2 bg-slate-900 text-white rounded hover:bg-slate-800" onclick="addItems()">Add</button>
  </div>

  <div class="overflow-x-auto rounded border border-slate-200 bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 text-slate-600">
        <tr>
          <th class="text-left font-medium px-3 py-2">ID</th>
          <th class="text-left font-medium px-3 py-2">Value</th>
          <th class="text-left font-medium px-3 py-2">Weight</th>
          <th class="text-left font-medium px-3 py-2">Enabled</th>
          <th class="text-left font-medium px-3 py-2">Cooldown</th>
          <th class="text-left font-medium px-3 py-2">Tags</th>
          <th class="text-left font-medium px-3 py-2">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for it in items %}
        <tr class="border-t border-slate-100">
          <td class="px-3 py-2">{{ it.id }}</td>
          <td class="px-3 py-2"><input id="v_{{ it.id }}" value="{{ it.value }}" class="border border-slate-300 rounded px-2 py-1 w-[28rem]"/></td>
          <td class="px-3 py-2"><input id="w_{{ it.id }}" type="number" step="0.1" value="{{ it.weight }}" class="border border-slate-300 rounded px-2 py-1 w-24"/></td>
          <td class="px-3 py-2"><input id="e_{{ it.id }}" type="checkbox" {% if it.enabled %}checked{% endif %} class="scale-125"/></td>
          <td class="px-3 py-2"><input id="c_{{ it.id }}" type="number" step="1" value="{{ it.cooldown_days }}" class="border border-slate-300 rounded px-2 py-1 w-24"/></td>
          <td class="px-3 py-2"><input id="t_{{ it.id }}" value='{{ it.tags }}' class="border border-slate-300 rounded px-2 py-1 w-60"/></td>
          <td class="px-3 py-2 flex gap-2">
            <button class="px-3 py-1.5 bg-slate-900 text-white rounded hover:bg-slate-800" onclick="saveItem({{ it.id }})">Save</button>
            <button class="px-3 py-1.5 bg-white border border-slate-300 rounded hover:bg-slate-100" onclick="delItem({{ it.id }})">Delete</button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="out" class="mt-4"></div>

  <script>
    async function addItems() {
      let text = document.getElementById('values').value.trim();
      let values = [];
      if (!text) return;
      try {
        const arr = JSON.parse(text);
        if (Array.isArray(arr)) values = arr.map(String);
      } catch (e) {
        values = text.split(/[\r\n,]+/).map(s => s.trim()).filter(Boolean);
      }
      const weight = parseFloat(document.getElementById('weight').value || '1');
      const cooldown_days = parseInt(document.getElementById('cooldown').value || '0', 10);
      const enabled = document.getElementById('enabled').checked;
      let tags = document.getElementById('tags').value.trim();
      try { tags = tags ? JSON.parse(tags) : []; } catch(e) { tags = []; }
      const res = await fetch(`/api/variables/{{ list_name }}`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({values, weight, cooldown_days, enabled, tags})
      });
      const data = await res.json();
      document.getElementById('out').innerHTML = '<pre>'+JSON.stringify(data, null, 2)+'</pre>';
      location.reload();
    }
    async function saveItem(id) {
      const value = document.getElementById('v_'+id).value;
      const weight = parseFloat(document.getElementById('w_'+id).value || '1');
      const enabled = document.getElementById('e_'+id).checked;
      const cooldown_days = parseInt(document.getElementById('c_'+id).value || '0', 10);
      let tags = document.getElementById('t_'+id).value;
      try { tags = tags ? JSON.parse(tags) : []; } catch(e) { tags = []; }
      const res = await fetch(`/api/variables/{{ list_name }}/${id}`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({value, weight, enabled, cooldown_days, tags})
      });
      const data = await res.json();
      document.getElementById('out').innerHTML = '<pre>'+JSON.stringify(data, null, 2)+'</pre>';
    }
    async function delItem(id) {
      if (!confirm('Delete item '+id+'?')) return;
      const res = await fetch(`/api/variables/{{ list_name }}/${id}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'delete'}) });
      const data = await res.json();
      document.getElementById('out').innerHTML = '<pre>'+JSON.stringify(data, null, 2)+'</pre>';
      location.reload();
    }
  </script>
{% endblock %}
